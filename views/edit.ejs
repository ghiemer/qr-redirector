<%- include('layout-header') %>
<style>
  .field-container {
    position: relative;
    margin-bottom: 15px;
  }
  .help-icon {
    display: inline-block;
    width: 16px;
    height: 16px;
    background: #007bff;
    color: white;
    border-radius: 50%;
    text-align: center;
    line-height: 16px;
    font-size: 12px;
    font-weight: bold;
    cursor: help;
    margin-left: 5px;
    position: relative;
  }
  .tooltip {
    visibility: hidden;
    opacity: 0;
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 5px;
    background-color: #333;
    color: white;
    text-align: left;
    border-radius: 6px;
    padding: 10px;
    z-index: 1;
    width: 300px;
    font-size: 13px;
    line-height: 1.4;
    transition: opacity 0.3s;
  }
  .tooltip::after {
    content: "";
    position: absolute;
    bottom: 100%;
    left: 20px;
    border-width: 5px;
    border-style: solid;
    border-color: transparent transparent #333 transparent;
  }
  .help-icon:hover .tooltip {
    visibility: visible;
    opacity: 1;
  }
  .navigation {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  .navigation a {
    margin-right: 15px;
    text-decoration: none;
    color: #007bff;
  }
  .navigation a:hover {
    text-decoration: underline;
  }
  .navigation a.active {
    font-weight: bold;
    color: #495057;
  }
</style>

<div class="navigation">
  <a href="/admin/dashboard">üìä Dashboard</a>
  <a href="/admin/routes/new" class="active">‚ûï Neue Route</a>
  <a href="/admin/settings">‚öôÔ∏è Einstellungen</a>
  <a href="#" onclick="logout()">üö™ Logout</a>
</div>

<h1><%= route ? 'Route bearbeiten' : 'Neue Route' %></h1>
<form method="POST">
  <% if (route && route.id) { %>
    <input type="hidden" name="id" value="<%= route.id %>">
  <% } %>
  
  <div class="field-container">
    <label>Alias 
      <span class="help-icon">?
        <span class="tooltip">
          <strong>Kurz-URL Bezeichnung</strong><br>
          <% if (route) { %>
            Der Alias kann nach der Erstellung nicht mehr ge√§ndert werden,<br>
            um bestehende QR-Codes und Links nicht zu brechen.<br><br>
            <strong>Deine Kurz-URL:</strong> https://domain.com/<%= route.alias %>
          <% } else { %>
            Der Alias ist der kurze Namen f√ºr deine URL (z.B. "shop", "angebot").<br><br>
            <strong>Wie:</strong> Wird zu https://domain.com/ALIAS<br>
            <strong>Wof√ºr:</strong> Einfach zu merkende, kurze Links<br>
            <strong>Beispiel:</strong> "sommersale" ‚Üí https://domain.com/sommersale<br>
            <strong>Hinweis:</strong> Nur Buchstaben, Zahlen und Bindestriche erlaubt. Keine Leerzeichen!
          <% } %>
        </span>
      </span>
    </label>
    <% if (route) { %>
      <input type="text" value="<%= route.alias %>" readonly style="background: #f8f9fa; color: #6c757d;">
      <input type="hidden" name="alias" value="<%= route.alias %>">
      <small style="color: #6c757d;">üîí Alias kann nicht ge√§ndert werden (sch√ºtzt QR-Codes und bestehende Links)</small>
    <% } else { %>
      <input type="text" name="alias" value="" required>
    <% } %>
  </div>

  <div class="field-container">
    <label>Ziel-URL 
      <span class="help-icon">?
        <span class="tooltip">
          <strong>Wohin soll weitergeleitet werden</strong><br>
          Die vollst√§ndige URL, zu der Besucher weitergeleitet werden sollen.<br><br>
          <strong>Wie:</strong> Muss mit http:// oder https:// beginnen<br>
          <strong>Wof√ºr:</strong> Das eigentliche Ziel deines kurzen Links<br>
          <strong>Beispiel:</strong> https://meinshop.de/produkte/sommersale<br>
          <strong>Tipp:</strong> UTM-Parameter werden automatisch angeh√§ngt
        </span>
      </span>
    </label>
    <input type="text" name="target" value="<%= route?.target || '' %>" required>
  </div>

  <div class="field-container">
    <label>UTM Source 
      <span class="help-icon">?
        <span class="tooltip">
          <strong>Traffic-Quelle verfolgen</strong><br>
          Identifiziert, woher der Traffic kommt (z.B. Newsletter, Social Media).<br><br>
          <strong>Wie:</strong> Wird als ?utm_source=WERT angeh√§ngt<br>
          <strong>Wof√ºr:</strong> Google Analytics kann zeigen, welche Quelle am besten funktioniert<br>
          <strong>Beispiele:</strong> "newsletter", "facebook", "instagram", "flyer"<br>
          <strong>Optional:</strong> Kann leer gelassen werden
        </span>
      </span>
    </label>
    <input type="text" name="utm_source" value="<%= route?.utm_source || '' %>">
  </div>

  <div class="field-container">
    <label>UTM Medium 
      <span class="help-icon">?
        <span class="tooltip">
          <strong>Marketing-Kanal klassifizieren</strong><br>
          Beschreibt die Art des Marketing-Kanals oder Mediums.<br><br>
          <strong>Wie:</strong> Wird als ?utm_medium=WERT angeh√§ngt<br>
          <strong>Wof√ºr:</strong> Unterscheidung zwischen verschiedenen Marketing-Arten<br>
          <strong>Beispiele:</strong> "email", "social", "cpc" (Cost-per-Click), "banner", "qr"<br>
          <strong>Tipp:</strong> Kombiniert mit Source ergibt sich: "facebook" + "social"
        </span>
      </span>
    </label>
    <input type="text" name="utm_medium" value="<%= route?.utm_medium || '' %>">
  </div>

  <div class="field-container">
    <label>UTM Campaign 
      <span class="help-icon">?
        <span class="tooltip">
          <strong>Kampagnen-Name zuordnen</strong><br>
          Identifiziert die spezifische Marketing-Kampagne oder Aktion.<br><br>
          <strong>Wie:</strong> Wird als ?utm_campaign=WERT angeh√§ngt<br>
          <strong>Wof√ºr:</strong> Erfolg einzelner Kampagnen messen und vergleichen<br>
          <strong>Beispiele:</strong> "sommersale2025", "black-friday", "produktlaunch"<br>
          <strong>Nutzen:</strong> Zeigt in Analytics, welche Kampagne am erfolgreichsten ist
        </span>
      </span>
    </label>
    <input type="text" name="utm_campaign" value="<%= route?.utm_campaign || '' %>">
  </div>

  <div class="field-container">
    <label>
      <input type="checkbox" name="active" <%= route?.active ? 'checked' : '' %>> 
      Aktiv 
      <span class="help-icon">?
        <span class="tooltip">
          <strong>Route aktivieren/deaktivieren</strong><br>
          Bestimmt, ob diese Kurz-URL funktioniert oder nicht.<br><br>
          <strong>Aktiviert:</strong> Link funktioniert normal, QR-Code kann gescannt werden<br>
          <strong>Deaktiviert:</strong> Link zeigt Fehlerseite (404), aber Daten bleiben erhalten<br>
          <strong>Wof√ºr:</strong> Tempor√§res Ausschalten ohne L√∂schen (z.B. nach Kampagnen-Ende)<br>
          <strong>Tipp:</strong> N√ºtzlich f√ºr zeitlich begrenzte Aktionen
        </span>
      </span>
    </label>
  </div>

  <% if (route) { %>
    <div class="field-container" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 20px 0;">
      <label style="font-weight: bold; color: #856404;">
        <input type="checkbox" id="confirmEdit" required style="margin-right: 10px;">
        ‚ö†Ô∏è Ich best√§tige, dass ich die √Ñnderungen an dieser Route speichern m√∂chte
      </label>
      <div style="font-size: 0.9em; color: #856404; margin-top: 8px;">
        <strong>Was wird ge√§ndert:</strong> Ziel-URL, UTM-Parameter und Aktiv-Status<br>
        <strong>Was bleibt unver√§ndert:</strong> Alias (<%= route.alias %>), QR-Codes und bestehende Links
      </div>
    </div>
  <% } %>

  <div class="button-group" style="display: flex; gap: 1rem; margin-top: 20px;">
    <button id="saveButton" <%= route ? 'disabled' : '' %>>
      <%= route ? '√Ñnderungen speichern' : 'Route erstellen' %>
    </button>
    <a href="/admin/dashboard" class="btn btn-secondary" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center;">
      Abbrechen
    </a>
  </div>
</form>

<% if (route) { %>
<script>
  // Enable save button only when confirmation is checked
  const confirmCheckbox = document.getElementById('confirmEdit');
  const saveButton = document.getElementById('saveButton');
  
  confirmCheckbox.addEventListener('change', function() {
    saveButton.disabled = !this.checked;
  });
</script>
<% } %>

<script>
function logout() {
  if (confirm('M√∂chtest du dich wirklich abmelden?')) {
    fetch('/admin/logout', { method: 'POST' })
      .then(() => window.location.href = '/admin/login');
  }
}
</script>

<%- include('layout-footer') %>
